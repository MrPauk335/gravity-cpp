name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: sdkmanager "ndk;25.2.9519653"

    - name: Fix Makefiles and Prepare C++
      run: |
        cd src
        
        # 1. C++ Setup
        if [ -f main.c ]; then mv main.c main.cpp; fi
        sed -i 's/$(ANDROID_ARCH_NAME)-gcc/$(ANDROID_ARCH_NAME)-g++/' Makefile
        sed -i 's/$(ANDROID_ARCH_NAME)-gcc/$(ANDROID_ARCH_NAME)-g++/' Makefile.Android
        sed -i 's/-std=c99/-std=c++17/' Makefile
        sed -i 's/-std=c99/-std=c++17/' Makefile.Android
        sed -i 's/-Werror//' Makefile
        sed -i 's/-Wstrict-prototypes//' Makefile

        # 2. УДАЛЕНИЕ "if not exist" (Создание папок)
        # Меняем на mkdir -p
        sed -i 's/if not exist .* mkdir/mkdir -p/g' Makefile.Android

        # 3. УДАЛЕНИЕ "if exist" (Очистка)
        sed -i '/if exist/d' Makefile.Android
        
        # 4. УДАЛЕНИЕ "cmd /c"
        sed -i 's/cmd \/c //g' Makefile.Android
        
        # 5. ИСПРАВЛЕНИЕ COPY (Самое важное!)
        # Меняем все варианты регистра
        sed -i 's/copy \/Y/cp -f/g' Makefile.Android
        sed -i 's/copy \/y/cp -f/g' Makefile.Android
        sed -i 's/COPY \/Y/cp -f/g' Makefile.Android
        
        # 6. ИСПРАВЛЕНИЕ СЛЕШЕЙ В ПУТЯХ
        # Меняем обратные слеши на прямые в путях проекта
        sed -i 's/android.gravity\\/android.gravity\//g' Makefile.Android
        sed -i 's/\\obj/\/obj/g' Makefile.Android
        sed -i 's/\\bin/\/bin/g' Makefile.Android
        sed -i 's/\\lib/\/lib/g' Makefile.Android
        sed -i 's/\\src/\/src/g' Makefile.Android
        sed -i 's/\\res/\/res/g' Makefile.Android
        sed -i 's/\\assets/\/assets/g' Makefile.Android
        
        # 7. ИСПРАВЛЕНИЕ ПУТИ К RAYLIB
        # Шаблон думает, что raylib лежит в ../../raylib, но у нас он внутри src/raylib (из-за checkout)
        # Меняем путь поиска библиотеки
        sed -i 's/..\\..\\raylib/raylib/g' Makefile.Android
        sed -i 's/..\/..\/raylib/raylib/g' Makefile.Android

    - name: Build APK
      run: |
        cd src
        export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
        
        # Запускаем сборку
        make PLATFORM=PLATFORM_ANDROID \
             PROJECT_NAME=gravity \
             PROJECT_SOURCE_FILES=main.cpp \
             ANDROID_ARCH=arm64-v8a \
             ANDROID_API_VERSION=29 \
             SHELL=/bin/bash

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: gravity-apk
        path: src/*.apk
