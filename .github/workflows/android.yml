name: Android Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: sdkmanager "ndk;25.2.9519653"

    # 1. Скачиваем Raylib
    - name: Download Raylib
      run: |
        cd src
        git clone --depth 1 https://github.com/raysan5/raylib.git raylib

    # 2. Собираем библиотеку Raylib
    - name: Build Raylib Library
      run: |
        cd src/raylib/src
        export ANDROID_NDK=$ANDROID_HOME/ndk/25.2.9519653
        export PATH=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        
        # Собираем либу с явным указанием компилятора Clang
        make PLATFORM=PLATFORM_ANDROID \
             ANDROID_ARCH=arm64-v8a \
             ANDROID_API_VERSION=29 \
             CC=aarch64-linux-android29-clang \
             AR=llvm-ar

    # 3. Готовим твой код
    - name: Fix Makefiles and Prepare C++
      run: |
        cd src
        
        # Переименовываем файл
        if [ -f main.c ]; then mv main.c main.cpp; fi
        
        # --- ПАТЧИМ MAKEFILE ИГРЫ ---
        
        # Заменяем gcc на clang++ (обязательно для NDK r25+)
        sed -i 's/gcc/clang++/' Makefile.Android
        # Удаляем старые стандарты и флаги ошибок
        sed -i 's/-std=c99/-std=c++17/' Makefile.Android
        sed -i 's/-Werror//' Makefile
        sed -i 's/-Wstrict-prototypes//' Makefile

        # Чистим Windows команды
        sed -i 's/cmd \/c //g' Makefile.Android
        sed -i '/if exist/d' Makefile.Android
        sed -i '/if not exist/d' Makefile.Android
        
        # Создаем папки (mkdir -p)
        sed -i 's/$(PROJECT_BUILD_PATH)/mkdir -p $(PROJECT_BUILD_PATH)/g' Makefile.Android
        
        # Исправляем copy и слеши
        sed -i 's/copy \/Y/cp -f/g' Makefile.Android
        sed -i 's/copy \/y/cp -f/g' Makefile.Android
        sed -i 's/\\/\//g' Makefile.Android
        
        # Указываем путь к Raylib (он теперь рядом, в папке raylib)
        sed -i 's/..\/..\/raylib/raylib/g' Makefile.Android

    # 4. Собираем APK
    - name: Build APK
      run: |
        cd src
        export ANDROID_NDK=$ANDROID_HOME/ndk/25.2.9519653
        export PATH=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        
        # Запускаем сборку без флага -i, чтобы видеть реальные ошибки
        make PLATFORM=PLATFORM_ANDROID \
             PROJECT_NAME=gravity \
             PROJECT_SOURCE_FILES=main.cpp \
             ANDROID_ARCH=arm64-v8a \
             ANDROID_API_VERSION=29 \
             CC=aarch64-linux-android29-clang++ \
             SHELL=/bin/bash

    # 5. Загружаем результат (ИСПРАВЛЕН ПУТЬ)
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: gravity-apk
        # Ищем APK во всех подпапках (так как он лежит в bin)
        path: src/**/*.apk
